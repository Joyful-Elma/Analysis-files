#if !defined(__CINT__) || defined(__MAKECINT__)
#include <TStyle.h>
#include <TGrid.h>
#include <TCanvas.h>
#include <TH2D.h>
#include <TLine.h>
#include <TView.h>
#include <TMath.h>
#include <TGeoManager.h>
#include "AliITSOnlineCalibrationSPDhandler.h"
#include "AliCDBManager.h"
#include "AliGeomManager.h"
#include "AliITSAlignMille2Module.h"
#endif

#include <fstream>
#include <iostream>
using namespace std;


///macro originale: https://twiki.cern.ch/twiki/pub/AliceSPD/WebHome/ShowSPDConfiguration.C (twiki dell'SPD)

void ShowSPDConfiguration()
{
  gStyle->SetOptStat(0);
  
  TGrid::Connect("alien://");
  if(!gGrid)
  {
    printf("no grid connection is available, exiting.\n");
    return;
  }
  
  /*const Int_t nTotRun = 270; ///Tutti i run
  Int_t nRun[nTotRun] = {189576,189577,189578,189596,189601,189603,189605,189607,189608,189610,189611,
                         189612,189616,189621,189623,189641,189642,189647,189648,189650,189654,189656,
			 189658,189659,189685,189687,189694,189696,189697,189698,189725,189728,189729,
			 189734,189735,189736,189737,190050,190057,190110,190112,190113,190115,190116,
			 190117,190118,190119,190136,190138,190141,190142,190147,190150,190206,190209,
			 190212,190214,190215,190216,190235,190237,190239,190240,190242,190244,190296,
			 190299,190301,190302,190304,190305,190307,190324,190325,190330,190336,190337,
			 190340,190341,190342,190374,190379,190380,190386,190388,190389,190390,190392,
			 190393,190407,190413,190414,190416,190417,190418,190419,190493,190495,190517,
			 190521,190535,190540,190541,190561,190578,190581,190585,190683,190685,190712,
			 190714,190815,190818,190819,190821,190822,190844,190848,190864,190866,190870,
			 190879,190894,190895,190898,190903,190904,190960,190968,190969,190970,190979,
		         190981,190983,190984,191022,191032,191079,191083,191105,191110,191121,191129,
			 191159,191163,191217,191222,191224,191227,191229,191230,191231,191232,191234,
			 191242,191244,191245,191247,191248,191275,191307,191309,191329,191337,191340,
			 191343,191344,191443,191447,191448,191450,191451,191485,191521,191527,191539,
			 191996,192003,192004,192067,192072,192073,192095,192117,192119,192120,192128,
			 192136,192140,192141,192166,192171,192172,192174,192177,192190,192192,192194,
			 192197,192199,192200,192201,192202,192205,192242,192244,192246,192264,192468,
			 192471,192492,192499,192505,192510,192531,192533,192534,192535,192542,192548,
			 192724,192727,192729,192731,192732,192745,192747,192750,192762,192765,192772,
			 192775,192778,192779,192796,192806,192808,192811,192813,192816,192820,192822,
			 192824,193000,193004,193005,193007,193008,193010,193011,193014,193044,193046,
			 193047,193049,193051,193079,193084,193141,193144,193179,193236,193240,193243,
			 193270,193274,193276,193295,193339,193341};*/

  /*const Int_t nTotRun = 131; ///V0
  Int_t nRun[nTotRun] = {189576,189577,189578,189596,189601,189603,189605,189607,189608,189610,189611,
                         189612,189616,189621,189623,189641,189642,189647,189648,189650,189654,189656,
			 189658,189659,189685,189687,189694,189696,189697,189698,190150,190209,190212,
			 190214,190215,190216,190240,190242,190244,190304,190305,190307,190336,190337,
			 190340,190341,190342,190386,190388,190389,190390,190392,190393,190416,190417,
			 190418,190419,190895,190898,190903,190904,190968,190969,190970,190979,190981,
			 190983,190984,191129,191227,191229,191230,191231,191232,191234,191242,191244,
			 191245,191247,191248,191450,191451,192004,192072,192073,192095,192128,192136,
			 192140,192141,192172,192174,192177,192194,192197,192199,192200,192201,192202,
			 192205,192246,192468,192471,192492,192499,192505,192510,192534,192535,192542,
			 192548,192729,192731,192732,192772,192775,192778,192779,192820,192822,192824,
			 193004,193005,193007,193008,193010,193011,193014,193047,193049,193051};*/

//   const Int_t nTotRun = 139; ///T0
//   Int_t nRun[nTotRun] = {189725,189728,189729,189734,189735,189736,189737,190050,190057,190110,190112,
//                          190113,190115,190116,190117,190118,190119,190136,190138,190141,190142,190147,
// 			 190206,190235,190237,190239,190296,190299,190301,190302,190324,190325,190330,
// 			 190374,190379,190380,190407,190413,190414,190493,190495,190517,190521,190535,
// 			 190540,190541,190561,190578,190581,190585,190683,190685,190712,190714,190815,
// 			 190818,190819,190821,190822,190844,190848,190864,190866,190870,190879,190894,
// 			 190960,191022,191032,191079,191083,191105,191110,191121,191159,191163,191217,
// 			 191222,191224,191275,191307,191309,191329,191337,191340,191343,191344,191443,
// 			 191447,191448,191485,191521,191527,191539,191996,192003,192067,192117,192119,
// 			 192120,192166,192171,192190,192192,192242,192244,192264,192531,192533,192724,
// 			 192727,192745,192747,192750,192762,192765,192796,192806,192808,192811,192813,
// 			 192816,193000,193044,193046,193079,193084,193141,193144,193179,193236,193240,
// 			 193243,193270,193274,193276,193295,193339,193341};

//   const Int_t nTotRun = 11; ///Run nella simulazione LHC14g1a
//   Int_t nRun[nTotRun] = {189601,189642,190960,191448,191451,192727,
//                          192729,193004,193044,193051,193274};
  
  const Int_t nTotRun = 13; //total number of runs
  Int_t nRun[nTotRun] = {282441, 282440, 282439, 282437, 282415, 282411, 282402, 282398, 282392, 282391, 282367, 282366, 282365};
  
  TH1D *dummy = new TH1D("","",nTotRun,0.5,nTotRun+0.5);
  dummy->GetYaxis()->SetRangeUser(0,170);
  dummy->GetYaxis()->SetTitle("Number of active modules");
  dummy->GetYaxis()->SetTitleOffset(1.2);
  dummy->GetXaxis()->SetTitle("Run    ");
  dummy->GetXaxis()->SetTitleOffset(-1);
  
  TGraph *nModL0 = new TGraph(nTotRun);
  nModL0->SetMarkerStyle(7);
  nModL0->SetMarkerColor(kBlue);
  
  TGraph *nModL1 = new TGraph(nTotRun);
  nModL1->SetMarkerStyle(7);
  nModL1->SetMarkerColor(kGreen);
  
  Int_t nActModL0,nActModL1;
  AliITSOnlineCalibrationSPDhandler *h = new AliITSOnlineCalibrationSPDhandler();
  
  TLegend *leg = new TLegend(0.2,0.2,0.35,0.35);
  leg->SetFillColor(kWhite);
  leg->SetLineColor(kWhite);
  leg->AddEntry(nModL0,"Inner layer","p");
  leg->AddEntry(nModL1,"Outer layer","p");
  
  ofstream outFile("list_active_module_LHC15o.txt");
  outFile << "Run" << "\t\t" << "Inner layer" << "\t" << "Outer layer" << endl;
  
  for(Int_t iRun=0; iRun<nTotRun; iRun++)
  {
    cout<<nRun[iRun]<<endl;
    dummy->GetXaxis()->SetBinLabel(iRun+1,Form("%d",nRun[iRun]));
    h->ReadDeadFromDB(nRun[iRun],"alien://Folder=/alice/data/2015/OCDB/");
    
    nActModL0 = 0;
    for(Int_t iMod=0; iMod<80; iMod++)
      if((h->GetNrBad(iMod))<1)
	nActModL0++;
    
    nModL0->SetPoint(iRun,iRun+1,nActModL0);
    
    nActModL1 = 0;
    for(Int_t iMod=80; iMod<240; iMod++)
      if((h->GetNrBad(iMod))<1)
	nActModL1++;
    
    nModL1->SetPoint(iRun,iRun+1,nActModL1);
    outFile << nRun[iRun] << "\t\t" << nActModL0 << "\t\t" << nActModL1 << endl;
  }
  
  outFile.close();
  
  dummy->Draw();
  nModL0->Draw("p");
  nModL1->Draw("p");
  leg->Draw();
}
